events {
    worker_connections 1024;
}

http {
    upstream backend {
        server backend1:8090;
        server backend2:8090;
    }

    server {
        listen 8090;

        client_max_body_size 5G;

        location / {
    proxy_pass http://backend;

    # 1️⃣ Detecta origen permitido
    set $cors_origin "";
    if ($http_origin ~* "^https?://(localhost:8070|192\.168\.1\.84:8070)$") {
        set $cors_origin $http_origin;
    }

    # 2️⃣ Encabezados CORS
    add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # 3️⃣ Manejo preflight
    if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' "$cors_origin";
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Origin, X-Requested-With, Content-Type, Accept, Authorization';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
    }
}

    }
}